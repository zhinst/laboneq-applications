# Copyright 2024 Zurich Instruments AG
# SPDX-License-Identifier: Apache-2.0

"""Tests for the resonator spectroscopy analysis using the testing utilities."""

import matplotlib as mpl
import matplotlib.pyplot as plt
import numpy as np
import pytest
from laboneq.workflow import handles
from laboneq.workflow.tasks.run_experiment import (
    AcquiredResult,
    RunExperimentResults,
)

from laboneq_applications.analysis import dispersive_shift


@pytest.fixture
def results_single_qubit():
    """Results from a dispersive shift experiment for states g, e, f.

    In the AcquiredResults below, the data is the magnitude of the acquired complex
    signal. Sweep points correspond to the qubit readout-resonator frequency.
    """
    data = {}
    data[handles.result_handle("q0", suffix="g")] = AcquiredResult(
        data=np.array(
            [
                -1.20330049e-05 - 1.96615942e-06j,
                -1.19748601e-05 + 9.96179147e-07j,
                -1.10371724e-05 + 4.82276335e-06j,
                -9.47375458e-06 + 7.74610652e-06j,
                -6.78054378e-06 + 9.29101438e-06j,
                -3.69335969e-06 + 1.06755472e-05j,
                -2.59438157e-07 + 1.13059607e-05j,
                2.09177597e-06 + 1.03159436e-05j,
                4.68647087e-06 + 9.93491950e-06j,
                7.11532264e-06 + 7.64310749e-06j,
                8.90885915e-06 + 6.48289658e-06j,
                1.01276533e-05 + 3.49972669e-06j,
                1.06837652e-05 + 2.45191377e-07j,
                9.99370663e-06 - 1.95588661e-06j,
                8.06469233e-06 - 4.50642147e-06j,
                6.72437517e-06 - 6.55399063e-06j,
                4.37318295e-06 - 7.64140667e-06j,
                2.19199473e-06 - 7.64111717e-06j,
                -5.38884394e-09 - 8.13342561e-06j,
                -2.66897854e-06 - 7.41768410e-06j,
                -3.75995110e-06 - 6.25449412e-06j,
                -5.65254407e-06 - 4.05048082e-06j,
                -5.89535814e-06 - 2.39295274e-06j,
                -5.55882829e-06 - 8.17926941e-08j,
                -6.00106922e-06 + 1.09112897e-06j,
                -5.11220510e-06 + 2.74017718e-06j,
                -2.73089852e-06 + 4.20936319e-06j,
                -2.97890215e-06 + 4.98340820e-06j,
                -4.12958394e-07 + 5.36599866e-06j,
                2.86244695e-07 + 4.97946221e-06j,
                1.49827258e-06 + 4.27397994e-06j,
                2.66319134e-06 + 2.67781267e-06j,
                3.22447376e-06 + 2.24967294e-06j,
                1.28357358e-06 + 1.44577005e-06j,
                2.84247067e-06 + 5.52490045e-07j,
                1.69320000e-06 - 2.40779317e-07j,
                1.10837134e-06 - 2.12092797e-07j,
                8.22139050e-07 + 4.60401466e-07j,
                2.00624972e-07 - 4.11898450e-07j,
                7.88665248e-07 + 1.37747185e-06j,
                5.08773204e-07 + 9.42903721e-07j,
                8.56560564e-07 + 2.50982360e-06j,
                1.35952174e-06 + 2.44144268e-06j,
                2.96891888e-06 + 2.09152846e-06j,
                4.16972041e-06 + 1.93677091e-06j,
                5.05430941e-06 + 1.76692344e-06j,
                5.97493577e-06 - 5.78692170e-07j,
                6.03742825e-06 - 3.44627723e-06j,
                5.87858250e-06 - 4.79483397e-06j,
                4.44738511e-06 - 6.94360261e-06j,
                2.17626612e-06 - 7.74988543e-06j,
                -4.71777631e-07 - 1.01087753e-05j,
                -3.19692144e-06 - 9.75139234e-06j,
                -5.95821056e-06 - 9.78928972e-06j,
                -9.32579409e-06 - 7.26518637e-06j,
                -1.26600677e-05 - 4.74275338e-06j,
                -1.42187323e-05 - 8.00305930e-08j,
                -1.36747749e-05 + 3.39434201e-06j,
                -1.39208461e-05 + 7.29210090e-06j,
                -1.08400070e-05 + 1.21711845e-05j,
                -7.21214979e-06 + 1.55085769e-05j,
                -2.94188829e-06 + 1.86027609e-05j,
                2.35929828e-06 + 1.93667816e-05j,
                7.78763474e-06 + 1.88409258e-05j,
                1.46143390e-05 + 1.65252327e-05j,
                2.01373760e-05 + 1.36946452e-05j,
                2.39329472e-05 + 7.44750618e-06j,
                2.58174933e-05 - 9.51903296e-08j,
                2.61968272e-05 - 6.75106329e-06j,
                2.39314563e-05 - 1.49337362e-05j,
                1.97255278e-05 - 2.27349210e-05j,
                1.30317747e-05 - 2.79545529e-05j,
                4.68435732e-06 - 3.21556023e-05j,
                -4.41006026e-06 - 3.27287238e-05j,
                -1.48579935e-05 - 3.05436906e-05j,
                -2.40987414e-05 - 2.64238795e-05j,
                -3.25859211e-05 - 1.84480042e-05j,
                -3.65047429e-05 - 9.06943985e-06j,
                -4.07755397e-05 + 3.29898952e-06j,
                -3.90345855e-05 + 1.67752390e-05j,
                -3.47800940e-05 + 2.75028028e-05j,
                -2.45640229e-05 + 3.84731930e-05j,
                -1.33776075e-05 + 4.62815615e-05j,
                2.52266085e-06 + 4.91084338e-05j,
                1.72486979e-05 + 4.89707052e-05j,
                3.27256845e-05 + 4.33578222e-05j,
                4.66502618e-05 + 3.29837383e-05j,
                5.53762752e-05 + 1.70844436e-05j,
                6.04209541e-05 - 1.07100532e-06j,
                5.89986838e-05 - 2.05657309e-05j,
                5.17342332e-05 - 3.88789851e-05j,
                3.75690759e-05 - 5.48824689e-05j,
                1.91972857e-05 - 6.56354549e-05j,
                -3.37452244e-06 - 6.90678394e-05j,
                -2.64394390e-05 - 6.59806319e-05j,
                -4.63333469e-05 - 5.45817876e-05j,
                -6.31933627e-05 - 3.59109816e-05j,
                -7.22318999e-05 - 1.41405782e-05j,
                -7.34056221e-05 + 9.76237096e-06j,
                -6.52730017e-05 + 3.47160818e-05j,
                -5.08233002e-05 + 5.42919630e-05j,
                -3.02880534e-05 + 6.68213399e-05j,
                -5.70813238e-06 + 7.21564251e-05j,
                1.72981134e-05 + 7.03746861e-05j,
                3.84731930e-05 + 5.93377763e-05j,
                5.50347626e-05 + 4.37312381e-05j,
                6.37683607e-05 + 2.30577191e-05j,
                6.61249989e-05 + 7.99773862e-07j,
                6.10652126e-05 - 1.88039615e-05j,
                5.15045256e-05 - 3.63355621e-05j,
                3.57197963e-05 - 4.78317835e-05j,
                1.80816929e-05 - 5.49814411e-05j,
                1.12591578e-06 - 5.57349902e-05j,
                -1.50762243e-05 - 5.10610514e-05j,
                -2.79898585e-05 - 4.17740400e-05j,
                -3.88381555e-05 - 2.97370703e-05j,
                -4.31414138e-05 - 1.57682667e-05j,
                -4.46753708e-05 - 1.21446416e-06j,
                -4.05837588e-05 + 1.08181752e-05j,
                -3.31649053e-05 + 2.09271575e-05j,
                -2.47199499e-05 + 2.90758805e-05j,
                -1.42770345e-05 + 3.31573145e-05j,
                -3.54835679e-06 + 3.35967255e-05j,
                5.49350950e-06 + 3.16133556e-05j,
                1.43257052e-05 + 2.61367637e-05j,
                1.92268140e-05 + 2.00044096e-05j,
                2.33071061e-05 + 1.24108924e-05j,
                2.43620805e-05 + 4.86153164e-06j,
                2.20882339e-05 - 1.74117576e-06j,
                1.91522290e-05 - 7.21488801e-06j,
                1.51757578e-05 - 1.13108662e-05j,
                9.56681565e-06 - 1.38030006e-05j,
                4.76961612e-06 - 1.36327507e-05j,
                1.09480147e-06 - 1.17396688e-05j,
                -1.53647953e-06 - 9.18490313e-06j,
                -3.01757125e-06 - 6.37254923e-06j,
                -2.81731920e-06 - 3.97202295e-06j,
                -5.62865551e-07 - 2.12501715e-06j,
                1.14972366e-06 + 7.50952042e-07j,
                4.36780427e-06 - 2.10130388e-06j,
                6.66569696e-06 - 3.99745886e-06j,
                6.90151391e-06 - 8.81790697e-06j,
                5.45056756e-06 - 1.35965035e-05j,
                8.89066988e-07 - 1.89867378e-05j,
                -5.79644275e-06 - 2.20594315e-05j,
                -1.42295830e-05 - 2.36272322e-05j,
                -2.37559444e-05 - 1.96631399e-05j,
                -3.34989651e-05 - 1.19900927e-05j,
                -4.09894148e-05 - 2.76294759e-07j,
                -4.26145372e-05 + 1.51259179e-05j,
                -3.95311030e-05 + 3.11974705e-05j,
                -2.83268027e-05 + 4.66427972e-05j,
                -1.10569969e-05 + 5.84348767e-05j,
                1.02675606e-05 + 6.34033326e-05j,
                3.37736666e-05 + 5.97201382e-05j,
                5.47658286e-05 + 4.67689601e-05j,
                7.08417569e-05 + 2.53556875e-05j,
                7.70259759e-05 - 2.71907563e-07j,
                7.49585182e-05 - 2.73068237e-05j,
                6.23891891e-05 - 5.17936175e-05j,
                4.13200134e-05 - 7.05681119e-05j,
                1.69675858e-05 - 8.04457200e-05j,
                -1.09584484e-05 - 8.09429815e-05j,
                -3.61100997e-05 - 7.32153637e-05j,
                -5.64532126e-05 - 5.73120777e-05j,
                -7.19338412e-05 - 3.49222852e-05j,
                -7.76783594e-05 - 1.07290717e-05j,
                -7.58477295e-05 + 1.31280045e-05j,
                -6.78555674e-05 + 3.45621732e-05j,
                -5.33756646e-05 + 5.38030557e-05j,
                -3.45149951e-05 + 6.49057419e-05j,
                -1.22638868e-05 + 7.21597148e-05j,
                9.33832037e-06 + 7.05278134e-05j,
                2.93390651e-05 + 6.32485205e-05j,
                4.63852860e-05 + 5.14321109e-05j,
                5.75935296e-05 + 3.58452654e-05j,
                6.51239770e-05 + 1.67955094e-05j,
                6.63135084e-05 - 1.78553524e-06j,
                6.27049371e-05 - 2.04614658e-05j,
                5.41664744e-05 - 3.57104076e-05j,
                4.06219969e-05 - 4.94226968e-05j,
                2.47687491e-05 - 5.76629914e-05j,
                8.28633333e-06 - 6.16684471e-05j,
                -9.15312679e-06 - 6.20585218e-05j,
                -2.59627988e-05 - 5.59391480e-05j,
                -3.93448914e-05 - 4.61729417e-05j,
                -5.01215171e-05 - 3.24519139e-05j,
                -5.70727837e-05 - 1.76774268e-05j,
                -5.80746552e-05 - 1.38496460e-06j,
                -5.60937526e-05 + 1.49341579e-05j,
                -4.89482140e-05 + 3.01857944e-05j,
                -3.85745830e-05 + 4.28143496e-05j,
                -2.69491489e-05 + 5.10336200e-05j,
                -1.11295869e-05 + 5.60054891e-05j,
                5.11649698e-06 + 5.63532135e-05j,
                2.04315858e-05 + 5.25239483e-05j,
                3.45226084e-05 + 4.55421779e-05j,
                4.41880670e-05 + 3.39979718e-05j,
                5.19140895e-05 + 2.08774934e-05j,
                5.51993943e-05 + 4.34979004e-06j,
                5.41498999e-05 - 1.06975777e-05j,
            ]
        )
    )
    data[handles.result_handle("q0", suffix="e")] = AcquiredResult(
        data=np.array(
            [
                -1.22152620e-05 - 1.74678078e-06j,
                -1.24745309e-05 + 9.62860313e-07j,
                -1.02980974e-05 + 4.52735721e-06j,
                -8.06954907e-06 + 7.48796481e-06j,
                -6.45331710e-06 + 8.74218585e-06j,
                -3.66289715e-06 + 1.03133596e-05j,
                -1.07115997e-06 + 1.12890514e-05j,
                1.94158919e-06 + 9.51651312e-06j,
                5.58545136e-06 + 8.78868087e-06j,
                6.42213085e-06 + 6.91645106e-06j,
                8.19693222e-06 + 5.94682603e-06j,
                9.47545243e-06 + 2.49017316e-06j,
                9.34634434e-06 + 1.04493050e-07j,
                8.29011634e-06 - 1.91164466e-06j,
                8.19771122e-06 - 3.89075135e-06j,
                6.28015737e-06 - 6.12030024e-06j,
                4.06755268e-06 - 6.56318838e-06j,
                1.78865684e-06 - 7.90896947e-06j,
                -4.09911250e-07 - 6.75169714e-06j,
                -1.46948577e-06 - 6.72591710e-06j,
                -2.81542252e-06 - 5.53238049e-06j,
                -5.67128294e-06 - 3.12269433e-06j,
                -5.20651121e-06 - 1.62933045e-06j,
                -4.67314903e-06 - 4.69597052e-07j,
                -4.78647311e-06 + 1.39165647e-06j,
                -2.83735104e-06 + 1.36746895e-06j,
                -2.00568682e-06 + 3.08454707e-06j,
                -1.24721227e-06 + 2.53676251e-06j,
                -7.40363910e-07 + 2.81818344e-06j,
                -4.21780384e-07 + 1.99262727e-06j,
                5.49328758e-07 + 1.56066791e-06j,
                1.42215881e-06 + 8.17764311e-07j,
                1.10064237e-06 + 3.01257461e-07j,
                -3.82472686e-08 + 1.06698528e-06j,
                -6.73742907e-07 - 3.67882857e-07j,
                -4.96271944e-07 + 2.03289048e-07j,
                -1.53505680e-06 + 1.42750212e-06j,
                -1.99778397e-06 + 2.04101287e-06j,
                -1.22704845e-06 + 3.56231209e-06j,
                -1.58275663e-07 + 4.55665716e-06j,
                1.00921244e-06 + 6.11385080e-06j,
                3.68356232e-06 + 6.16039334e-06j,
                5.95648526e-06 + 6.13718514e-06j,
                7.99624634e-06 + 4.87610093e-06j,
                9.39803369e-06 + 3.32745563e-06j,
                1.19596040e-05 - 3.69121006e-07j,
                1.17495811e-05 - 4.46524901e-06j,
                1.13827542e-05 - 7.23829404e-06j,
                9.16533809e-06 - 1.14452132e-05j,
                5.62769739e-06 - 1.48686092e-05j,
                1.20803422e-06 - 1.64884755e-05j,
                -5.07002194e-06 - 1.79112849e-05j,
                -1.01806855e-05 - 1.64136021e-05j,
                -1.60150531e-05 - 1.33716806e-05j,
                -2.11199311e-05 - 7.99731822e-06j,
                -2.35201348e-05 - 1.40913268e-06j,
                -2.44114902e-05 + 5.62487077e-06j,
                -2.17715569e-05 + 1.43178212e-05j,
                -1.79430205e-05 + 2.26606981e-05j,
                -9.48384561e-06 + 2.80784270e-05j,
                -5.50806358e-07 + 3.24161890e-05j,
                1.06427049e-05 + 3.22825317e-05j,
                2.13615006e-05 + 2.86560984e-05j,
                3.00937047e-05 + 2.09754057e-05j,
                3.75844431e-05 + 1.04899648e-05j,
                3.84617126e-05 - 1.61478795e-06j,
                3.74590265e-05 - 1.52096497e-05j,
                3.03180807e-05 - 2.62869210e-05j,
                2.11666109e-05 - 3.51120259e-05j,
                8.97507534e-06 - 3.94211152e-05j,
                -5.42349267e-06 - 3.92059574e-05j,
                -1.62501725e-05 - 3.55215533e-05j,
                -2.65338836e-05 - 2.79331017e-05j,
                -3.20008936e-05 - 1.69853907e-05j,
                -3.62805275e-05 - 6.46926293e-06j,
                -3.54643431e-05 + 5.27114449e-06j,
                -3.16390074e-05 + 1.45466914e-05j,
                -2.43318054e-05 + 2.21278015e-05j,
                -1.76673065e-05 + 2.70147123e-05j,
                -9.24230167e-06 + 3.00036046e-05j,
                -1.23385162e-06 + 3.21337803e-05j,
                8.85453508e-06 + 2.94086277e-05j,
                1.44738329e-05 + 2.71824910e-05j,
                2.25038804e-05 + 2.16707228e-05j,
                2.60833706e-05 + 1.61841291e-05j,
                3.04869272e-05 + 7.60357395e-06j,
                3.17702252e-05 + 5.80779715e-07j,
                3.18346500e-05 - 7.91451035e-06j,
                2.88790512e-05 - 1.68873365e-05j,
                2.38625944e-05 - 2.31980521e-05j,
                1.55975605e-05 - 2.91617763e-05j,
                7.56127803e-06 - 3.34032759e-05j,
                -2.41299938e-06 - 3.40874274e-05j,
                -1.18160015e-05 - 3.38872849e-05j,
                -2.27805768e-05 - 2.80534549e-05j,
                -3.03118891e-05 - 2.06376215e-05j,
                -3.60214518e-05 - 1.04017873e-05j,
                -3.73515964e-05 + 8.80815643e-07j,
                -3.69770247e-05 + 1.09622684e-05j,
                -3.10601742e-05 + 2.28900190e-05j,
                -2.16141299e-05 + 3.07296943e-05j,
                -1.01345724e-05 + 3.51086335e-05j,
                1.86297279e-07 + 3.74686784e-05j,
                1.18709807e-05 + 3.38513489e-05j,
                2.22092107e-05 + 2.88309389e-05j,
                2.85558556e-05 + 1.96754837e-05j,
                3.32798420e-05 + 1.11181442e-05j,
                3.20698251e-05 + 6.62358878e-07j,
                3.03395587e-05 - 9.20206458e-06j,
                2.53558018e-05 - 1.63646670e-05j,
                1.88140404e-05 - 2.19241370e-05j,
                1.16203781e-05 - 2.37337461e-05j,
                4.49962789e-06 - 2.56382802e-05j,
                -3.60794966e-06 - 2.33349603e-05j,
                -9.03620317e-06 - 2.14126694e-05j,
                -1.37962166e-05 - 1.60933630e-05j,
                -1.53115007e-05 - 1.10367114e-05j,
                -1.67145867e-05 - 6.95383889e-06j,
                -1.52746612e-05 - 2.25723942e-06j,
                -1.49662313e-05 + 2.06445259e-06j,
                -1.27993188e-05 + 2.44867883e-06j,
                -1.11437930e-05 + 5.77330054e-06j,
                -9.12002598e-06 + 6.40478429e-06j,
                -6.75654372e-06 + 8.48206230e-06j,
                -6.19514829e-06 + 8.56025886e-06j,
                -4.66812726e-06 + 9.70159952e-06j,
                -2.94710580e-06 + 1.11388672e-05j,
                -3.68437056e-06 + 1.09080159e-05j,
                5.66815894e-07 + 1.22553457e-05j,
                1.12083038e-06 + 1.41992289e-05j,
                6.90549728e-06 + 1.42825415e-05j,
                9.26636964e-06 + 1.51384065e-05j,
                1.36829751e-05 + 1.25711812e-05j,
                1.88999237e-05 + 9.98052594e-06j,
                2.15326781e-05 + 5.80908969e-06j,
                2.58611978e-05 + 5.65903021e-07j,
                2.65686493e-05 - 6.22653452e-06j,
                2.64531514e-05 - 1.52234492e-05j,
                2.15231845e-05 - 2.20559596e-05j,
                1.66470266e-05 - 3.07317597e-05j,
                7.59892358e-06 - 3.45434711e-05j,
                -2.72821905e-06 - 4.03523902e-05j,
                -1.43032965e-05 - 3.88210545e-05j,
                -2.67930756e-05 - 3.48129041e-05j,
                -3.77075687e-05 - 2.62619561e-05j,
                -4.60914592e-05 - 1.54226449e-05j,
                -5.03111334e-05 - 6.87457787e-07j,
                -5.05324038e-05 + 1.35440532e-05j,
                -4.56737973e-05 + 3.07159930e-05j,
                -3.62310934e-05 + 4.62830677e-05j,
                -2.17419850e-05 + 5.67603098e-05j,
                -2.66032278e-06 + 6.34185577e-05j,
                1.75409087e-05 + 6.48923307e-05j,
                3.89282838e-05 + 5.74410304e-05j,
                5.49574267e-05 + 4.34656610e-05j,
                6.87871016e-05 + 2.38890568e-05j,
                7.44072621e-05 + 1.74085692e-06j,
                7.21989464e-05 - 2.31335515e-05j,
                6.27246306e-05 - 4.41902665e-05j,
                4.56139509e-05 - 6.27220807e-05j,
                2.36030602e-05 - 7.34913573e-05j,
                -1.02803648e-06 - 7.81843368e-05j,
                -2.46690314e-05 - 7.45033411e-05j,
                -4.46397441e-05 - 6.17303506e-05j,
                -6.12623925e-05 - 4.46147335e-05j,
                -7.13271219e-05 - 2.40545780e-05j,
                -7.45988597e-05 - 1.69427020e-06j,
                -7.05099396e-05 + 2.07154990e-05j,
                -6.06394024e-05 + 3.99689767e-05j,
                -4.58580497e-05 + 5.55390322e-05j,
                -2.56758773e-05 + 6.47685536e-05j,
                -6.06875224e-06 + 6.82680157e-05j,
                1.41900269e-05 + 6.71498520e-05j,
                3.30443084e-05 + 5.90980975e-05j,
                4.77525197e-05 + 4.65199838e-05j,
                5.80502443e-05 + 3.15662162e-05j,
                6.33321531e-05 + 1.30500250e-05j,
                6.33392627e-05 - 4.65895208e-06j,
                5.89189685e-05 - 2.29381335e-05j,
                5.06803612e-05 - 3.77223305e-05j,
                3.86563308e-05 - 4.96412455e-05j,
                2.15984592e-05 - 5.76153566e-05j,
                5.58670319e-06 - 6.08530202e-05j,
                -1.14549379e-05 - 5.94295097e-05j,
                -2.71052736e-05 - 5.26070131e-05j,
                -4.02179194e-05 - 4.37907971e-05j,
                -5.01688749e-05 - 3.05295195e-05j,
                -5.61167706e-05 - 1.49835851e-05j,
                -5.68768553e-05 + 7.49593279e-07j,
                -5.48891969e-05 + 1.64167671e-05j,
                -4.88043127e-05 + 3.01778280e-05j,
                -3.71748652e-05 + 4.29095485e-05j,
                -2.47290176e-05 + 5.04006692e-05j,
                -9.62269008e-06 + 5.49860814e-05j,
                5.06306031e-06 + 5.49533372e-05j,
                2.07559240e-05 + 5.10557165e-05j,
                3.33649530e-05 + 4.44096981e-05j,
                4.40777678e-05 + 3.28613915e-05j,
                5.23265913e-05 + 1.93618833e-05j,
                5.46487188e-05 + 5.35558734e-06j,
                5.35851522e-05 - 1.11628539e-05j,
            ]
        )
    )
    data[handles.result_handle("q0", suffix="f")] = AcquiredResult(
        data=np.array(
            [
                -1.08358392e-05 - 2.27586127e-06j,
                -1.06866682e-05 + 1.31050528e-06j,
                -9.60417670e-06 + 3.96415215e-06j,
                -8.42573802e-06 + 6.63420565e-06j,
                -5.93492355e-06 + 7.89739330e-06j,
                -3.36412854e-06 + 9.35863475e-06j,
                -1.43262377e-06 + 1.07661010e-05j,
                1.51113226e-06 + 9.69891069e-06j,
                3.93566705e-06 + 9.31721213e-06j,
                6.09513754e-06 + 5.96617720e-06j,
                7.25955727e-06 + 4.06202055e-06j,
                8.37073883e-06 + 2.56336391e-06j,
                7.43228106e-06 - 2.27085595e-07j,
                7.19566794e-06 - 2.06305331e-06j,
                6.43103710e-06 - 4.41566629e-06j,
                4.19682117e-06 - 5.02159938e-06j,
                3.11138572e-06 - 5.85894002e-06j,
                1.78700323e-06 - 5.52401626e-06j,
                -4.06308650e-07 - 5.27295914e-06j,
                -1.52445133e-06 - 3.98426517e-06j,
                -1.26431863e-06 - 3.03241663e-06j,
                -2.44527881e-06 - 1.82139529e-06j,
                -2.12273498e-06 - 1.03105376e-06j,
                -1.41829473e-06 - 1.04889657e-06j,
                -6.51920734e-07 - 1.09113863e-07j,
                4.68769200e-09 + 2.18857555e-07j,
                -1.13539117e-07 - 9.38629360e-08j,
                -1.25112886e-07 - 9.80166074e-07j,
                1.12127709e-07 - 1.59295123e-06j,
                -9.78307569e-07 - 2.46326155e-06j,
                -1.78658711e-06 - 1.78218795e-06j,
                -4.35924818e-06 - 2.81268557e-06j,
                -6.47612494e-06 - 2.03650226e-06j,
                -6.37831250e-06 + 9.97470293e-08j,
                -8.34727927e-06 + 1.55389234e-06j,
                -8.36697030e-06 + 5.71452852e-06j,
                -6.82521468e-06 + 1.02264428e-05j,
                -4.43489998e-06 + 1.56607372e-05j,
                5.16845355e-07 + 1.54294538e-05j,
                6.74347887e-06 + 1.70306671e-05j,
                1.36746651e-05 + 1.51544018e-05j,
                1.93668164e-05 + 1.00807398e-05j,
                2.24610195e-05 + 2.71610381e-06j,
                2.35593003e-05 - 6.37080714e-06j,
                1.98500343e-05 - 1.48739600e-05j,
                1.36293203e-05 - 2.18371656e-05j,
                5.14946344e-06 - 2.47236074e-05j,
                -3.64791225e-06 - 2.42729025e-05j,
                -1.20480224e-05 - 2.12480710e-05j,
                -1.72673776e-05 - 1.51891737e-05j,
                -1.93536377e-05 - 9.48610506e-06j,
                -1.99098825e-05 - 3.24902496e-06j,
                -1.85526222e-05 + 2.98169102e-06j,
                -1.74964265e-05 + 7.62862303e-06j,
                -1.36755458e-05 + 1.12330840e-05j,
                -1.12253397e-05 + 1.38875371e-05j,
                -6.67639107e-06 + 1.75020647e-05j,
                -3.28865292e-06 + 1.78964496e-05j,
                1.78365473e-06 + 1.96322663e-05j,
                8.00882864e-06 + 1.77606421e-05j,
                1.09365654e-05 + 1.65200887e-05j,
                1.56608764e-05 + 1.32633334e-05j,
                1.99437070e-05 + 9.50113359e-06j,
                2.20303018e-05 + 3.21040938e-06j,
                2.29427396e-05 - 2.92223625e-06j,
                2.15296898e-05 - 9.08492045e-06j,
                1.74576899e-05 - 1.59376462e-05j,
                1.33290688e-05 - 2.07430855e-05j,
                5.26316546e-06 - 2.44815258e-05j,
                -1.19836411e-06 - 2.50055582e-05j,
                -8.83887602e-06 - 2.23449034e-05j,
                -1.50722908e-05 - 1.93198147e-05j,
                -1.98005049e-05 - 1.31654443e-05j,
                -2.18456483e-05 - 7.88055601e-06j,
                -2.25328044e-05 - 2.63898084e-07j,
                -2.09472819e-05 + 7.28090730e-06j,
                -1.83219922e-05 + 1.21283849e-05j,
                -1.38892800e-05 + 1.58883128e-05j,
                -8.94415833e-06 + 1.93592120e-05j,
                -4.51608462e-06 + 2.00021358e-05j,
                2.41878216e-06 + 1.98918343e-05j,
                6.73147330e-06 + 1.84047752e-05j,
                1.15210255e-05 + 1.71020996e-05j,
                1.47561555e-05 + 1.34869721e-05j,
                1.83026087e-05 + 9.10643287e-06j,
                2.00286872e-05 + 6.41927378e-06j,
                2.10333499e-05 + 1.41053829e-06j,
                2.05815207e-05 - 4.86491348e-06j,
                2.07010098e-05 - 9.74248685e-06j,
                1.66181483e-05 - 1.48938147e-05j,
                1.32880662e-05 - 1.95240302e-05j,
                7.07651245e-06 - 2.16115621e-05j,
                -2.95728907e-07 - 2.35463640e-05j,
                -6.65684632e-06 - 2.59053394e-05j,
                -1.28328130e-05 - 2.20296235e-05j,
                -1.87213631e-05 - 1.67530223e-05j,
                -2.29960559e-05 - 1.02118785e-05j,
                -2.61742630e-05 - 3.45885954e-06j,
                -2.56376715e-05 + 4.70044906e-06j,
                -2.28995602e-05 + 1.16039407e-05j,
                -1.90193003e-05 + 1.80050857e-05j,
                -1.19270996e-05 + 2.23658591e-05j,
                -4.75115478e-06 + 2.55069333e-05j,
                2.49546771e-06 + 2.43372541e-05j,
                1.02329262e-05 + 2.17979275e-05j,
                1.65879173e-05 + 1.82292137e-05j,
                1.90797813e-05 + 1.21227951e-05j,
                2.20541113e-05 + 6.18312620e-06j,
                2.22580497e-05 + 4.00926697e-07j,
                1.98117046e-05 - 4.83639135e-06j,
                1.71971873e-05 - 9.15743564e-06j,
                1.41305044e-05 - 1.18435401e-05j,
                9.93292282e-06 - 1.41451245e-05j,
                6.76684254e-06 - 1.50711888e-05j,
                2.72169599e-06 - 1.70307513e-05j,
                -1.66969042e-07 - 1.62564788e-05j,
                -2.92011148e-06 - 1.48358536e-05j,
                -5.62955090e-06 - 1.37927255e-05j,
                -9.81118219e-06 - 1.18347706e-05j,
                -1.00292889e-05 - 1.09205039e-05j,
                -1.29262382e-05 - 8.04890610e-06j,
                -1.44547254e-05 - 6.73980078e-06j,
                -1.61883095e-05 - 2.41908247e-06j,
                -1.80754974e-05 + 1.76228103e-06j,
                -1.81833244e-05 + 5.76087153e-06j,
                -1.80866613e-05 + 1.06343658e-05j,
                -1.42946406e-05 + 1.46159237e-05j,
                -1.31205106e-05 + 2.01821679e-05j,
                -6.40540428e-06 + 2.37738651e-05j,
                7.05340582e-08 + 2.60175139e-05j,
                7.72704275e-06 + 2.75535462e-05j,
                1.54123588e-05 + 2.65922518e-05j,
                2.36430311e-05 + 2.20305641e-05j,
                3.07996238e-05 + 1.62616321e-05j,
                3.57076173e-05 + 7.55947601e-06j,
                3.82836394e-05 - 2.66890168e-06j,
                3.82781984e-05 - 1.48462936e-05j,
                3.47404016e-05 - 2.61771456e-05j,
                2.61690175e-05 - 3.65271749e-05j,
                1.52107540e-05 - 4.38332167e-05j,
                2.37660864e-06 - 4.84483280e-05j,
                -1.25879890e-05 - 4.84186362e-05j,
                -2.67639830e-05 - 4.47448422e-05j,
                -4.09318876e-05 - 3.56930519e-05j,
                -5.01320824e-05 - 2.20898251e-05j,
                -5.59619342e-05 - 5.92911547e-06j,
                -5.69521416e-05 + 1.01100809e-05j,
                -5.39839883e-05 + 2.76999641e-05j,
                -4.43519464e-05 + 4.34979156e-05j,
                -3.02481756e-05 + 5.69714501e-05j,
                -1.13623664e-05 + 6.54552964e-05j,
                8.29338134e-06 + 6.67293818e-05j,
                2.94252066e-05 + 6.29651758e-05j,
                4.69216596e-05 + 5.18290098e-05j,
                6.23143254e-05 + 3.58049316e-05j,
                7.13494604e-05 + 1.53228637e-05j,
                7.42285310e-05 - 7.51684774e-06j,
                6.96873436e-05 - 3.03635850e-05j,
                5.71520968e-05 - 5.01735559e-05j,
                3.88667737e-05 - 6.62717063e-05j,
                1.73312376e-05 - 7.52183497e-05j,
                -6.45401280e-06 - 7.57391530e-05j,
                -2.89553441e-05 - 6.96736832e-05j,
                -4.89499482e-05 - 5.82404076e-05j,
                -6.33342898e-05 - 3.99283615e-05j,
                -7.16222409e-05 - 1.90300902e-05j,
                -7.26631819e-05 + 1.56013888e-06j,
                -6.81312802e-05 + 2.36642801e-05j,
                -5.70672955e-05 + 4.26660010e-05j,
                -4.18939902e-05 + 5.66194723e-05j,
                -2.32673513e-05 + 6.46661857e-05j,
                -3.02595577e-06 + 6.72858860e-05j,
                1.48287094e-05 + 6.54812471e-05j,
                3.25022596e-05 + 5.79306252e-05j,
                4.74469220e-05 + 4.50788968e-05j,
                5.79267326e-05 + 2.96483942e-05j,
                6.26575533e-05 + 1.08689298e-05j,
                6.23439061e-05 - 6.22117327e-06j,
                5.73872803e-05 - 2.32036873e-05j,
                4.90465283e-05 - 3.75502080e-05j,
                3.72757943e-05 - 4.97686749e-05j,
                2.08546250e-05 - 5.64881300e-05j,
                4.35846852e-06 - 6.02985697e-05j,
                -1.15710355e-05 - 5.79216953e-05j,
                -2.70286499e-05 - 5.26876309e-05j,
                -3.99076207e-05 - 4.26069226e-05j,
                -4.98924550e-05 - 3.05037898e-05j,
                -5.53748689e-05 - 1.46591953e-05j,
                -5.70857180e-05 + 4.12369758e-07j,
                -5.48900207e-05 + 1.63270143e-05j,
                -4.82797333e-05 + 3.02373579e-05j,
                -3.68204717e-05 + 4.19704949e-05j,
                -2.49684282e-05 + 5.08754480e-05j,
                -8.13688999e-06 + 5.45289320e-05j,
                6.14819009e-06 + 5.41916394e-05j,
                2.08797487e-05 + 5.09302439e-05j,
                3.40786762e-05 + 4.33260790e-05j,
                4.48396544e-05 + 3.23412872e-05j,
                5.17228325e-05 + 1.89215756e-05j,
                5.49793862e-05 + 3.51984524e-06j,
                5.36154245e-05 - 1.18715973e-05j,
            ]
        )
    )

    sweep_points = np.array(
        [
            6.69445946e09,
            6.69495946e09,
            6.69545946e09,
            6.69595946e09,
            6.69645946e09,
            6.69695946e09,
            6.69745946e09,
            6.69795946e09,
            6.69845946e09,
            6.69895946e09,
            6.69945946e09,
            6.69995946e09,
            6.70045946e09,
            6.70095946e09,
            6.70145946e09,
            6.70195946e09,
            6.70245946e09,
            6.70295946e09,
            6.70345946e09,
            6.70395946e09,
            6.70445946e09,
            6.70495946e09,
            6.70545946e09,
            6.70595946e09,
            6.70645946e09,
            6.70695946e09,
            6.70745946e09,
            6.70795946e09,
            6.70845946e09,
            6.70895946e09,
            6.70945946e09,
            6.70995946e09,
            6.71045946e09,
            6.71095946e09,
            6.71145946e09,
            6.71195946e09,
            6.71245946e09,
            6.71295946e09,
            6.71345946e09,
            6.71395946e09,
            6.71445946e09,
            6.71495946e09,
            6.71545946e09,
            6.71595946e09,
            6.71645946e09,
            6.71695946e09,
            6.71745946e09,
            6.71795946e09,
            6.71845946e09,
            6.71895946e09,
            6.71945946e09,
            6.71995946e09,
            6.72045946e09,
            6.72095946e09,
            6.72145946e09,
            6.72195946e09,
            6.72245946e09,
            6.72295946e09,
            6.72345946e09,
            6.72395946e09,
            6.72445946e09,
            6.72495946e09,
            6.72545946e09,
            6.72595946e09,
            6.72645946e09,
            6.72695946e09,
            6.72745946e09,
            6.72795946e09,
            6.72845946e09,
            6.72895946e09,
            6.72945946e09,
            6.72995946e09,
            6.73045946e09,
            6.73095946e09,
            6.73145946e09,
            6.73195946e09,
            6.73245946e09,
            6.73295946e09,
            6.73345946e09,
            6.73395946e09,
            6.73445946e09,
            6.73495946e09,
            6.73545946e09,
            6.73595946e09,
            6.73645946e09,
            6.73695946e09,
            6.73745946e09,
            6.73795946e09,
            6.73845946e09,
            6.73895946e09,
            6.73945946e09,
            6.73995946e09,
            6.74045946e09,
            6.74095946e09,
            6.74145946e09,
            6.74195946e09,
            6.74245946e09,
            6.74295946e09,
            6.74345946e09,
            6.74395946e09,
            6.74445946e09,
            6.74495946e09,
            6.74545946e09,
            6.74595946e09,
            6.74645946e09,
            6.74695946e09,
            6.74745946e09,
            6.74795946e09,
            6.74845946e09,
            6.74895946e09,
            6.74945946e09,
            6.74995946e09,
            6.75045946e09,
            6.75095946e09,
            6.75145946e09,
            6.75195946e09,
            6.75245946e09,
            6.75295946e09,
            6.75345946e09,
            6.75395946e09,
            6.75445946e09,
            6.75495946e09,
            6.75545946e09,
            6.75595946e09,
            6.75645946e09,
            6.75695946e09,
            6.75745946e09,
            6.75795946e09,
            6.75845946e09,
            6.75895946e09,
            6.75945946e09,
            6.75995946e09,
            6.76045946e09,
            6.76095946e09,
            6.76145946e09,
            6.76195946e09,
            6.76245946e09,
            6.76295946e09,
            6.76345946e09,
            6.76395946e09,
            6.76445946e09,
            6.76495946e09,
            6.76545946e09,
            6.76595946e09,
            6.76645946e09,
            6.76695946e09,
            6.76745946e09,
            6.76795946e09,
            6.76845946e09,
            6.76895946e09,
            6.76945946e09,
            6.76995946e09,
            6.77045946e09,
            6.77095946e09,
            6.77145946e09,
            6.77195946e09,
            6.77245946e09,
            6.77295946e09,
            6.77345946e09,
            6.77395946e09,
            6.77445946e09,
            6.77495946e09,
            6.77545946e09,
            6.77595946e09,
            6.77645946e09,
            6.77695946e09,
            6.77745946e09,
            6.77795946e09,
            6.77845946e09,
            6.77895946e09,
            6.77945946e09,
            6.77995946e09,
            6.78045946e09,
            6.78095946e09,
            6.78145946e09,
            6.78195946e09,
            6.78245946e09,
            6.78295946e09,
            6.78345946e09,
            6.78395946e09,
            6.78445946e09,
            6.78495946e09,
            6.78545946e09,
            6.78595946e09,
            6.78645946e09,
            6.78695946e09,
            6.78745946e09,
            6.78795946e09,
            6.78845946e09,
            6.78895946e09,
            6.78945946e09,
            6.78995946e09,
            6.79045946e09,
            6.79095946e09,
            6.79145946e09,
            6.79195946e09,
            6.79245946e09,
            6.79295946e09,
            6.79345946e09,
            6.79395946e09,
            6.79445946e09,
        ]
    )
    return RunExperimentResults(data=data), sweep_points


class TestDispersiveShiftAnalysisSingleQubit:
    def test_create_and_run_ge(
        self, single_tunable_transmon_platform, results_single_qubit
    ):
        [q0] = single_tunable_transmon_platform.qpu.qubits
        options = dispersive_shift.analysis_workflow.options()

        result = dispersive_shift.analysis_workflow(
            result=results_single_qubit[0],
            qubit=q0,
            frequencies=results_single_qubit[1],
            states="ge",
            options=options,
        ).run()

        assert len(result.tasks) == 4

        proc_data_dict = result.tasks["calculate_signal_differences"].output
        assert len(proc_data_dict) == 1
        np.testing.assert_array_almost_equal(
            proc_data_dict["ge"][0],
            np.array(
                [
                    2.85209796e-07,
                    5.00780431e-07,
                    7.95925067e-07,
                    1.42773605e-06,
                    6.38975783e-07,
                    3.63466415e-07,
                    8.11897915e-07,
                    8.13415769e-07,
                    1.45671854e-06,
                    1.00426312e-06,
                    8.91185498e-07,
                    1.20190029e-06,
                    1.34480128e-06,
                    1.70416467e-06,
                    6.29875959e-07,
                    6.20819467e-07,
                    1.12069823e-06,
                    4.84175907e-07,
                    1.43972634e-06,
                    1.38467487e-06,
                    1.18894168e-06,
                    9.27975705e-07,
                    1.02841095e-06,
                    9.66860886e-07,
                    1.25122360e-06,
                    2.65693223e-06,
                    1.33833602e-06,
                    2.99746976e-06,
                    2.56876562e-06,
                    3.06960624e-06,
                    2.87446631e-06,
                    2.23605492e-06,
                    2.88218366e-06,
                    1.37502300e-06,
                    3.63467251e-06,
                    2.23405105e-06,
                    3.11062435e-06,
                    3.23269211e-06,
                    4.22286642e-06,
                    3.31721515e-06,
                    5.19510665e-06,
                    4.61720677e-06,
                    5.89835452e-06,
                    5.74698749e-06,
                    5.41010755e-06,
                    7.22812415e-06,
                    6.96073655e-06,
                    6.55376997e-06,
                    7.41824149e-06,
                    8.01241948e-06,
                    8.79206630e-06,
                    9.05665539e-06,
                    9.65183916e-06,
                    1.06758422e-05,
                    1.18168390e-05,
                    1.13601974e-05,
                    1.16806770e-05,
                    1.35970687e-05,
                    1.58862100e-05,
                    1.59649472e-05,
                    1.81725299e-05,
                    1.92789342e-05,
                    2.11512434e-05,
                    2.24079621e-05,
                    2.37497398e-05,
                    2.38780246e-05,
                    2.63875261e-05,
                    2.65755911e-05,
                    2.88035983e-05,
                    2.86936415e-05,
                    3.00627388e-05,
                    3.02438742e-05,
                    3.15025091e-05,
                    3.17664386e-05,
                    3.22258131e-05,
                    3.36712258e-05,
                    3.30082806e-05,
                    3.34880317e-05,
                    3.31123232e-05,
                    3.25970832e-05,
                    3.38643815e-05,
                    3.46260937e-05,
                    3.37709523e-05,
                    3.39422615e-05,
                    3.39560158e-05,
                    3.58242697e-05,
                    3.56562367e-05,
                    3.43388383e-05,
                    3.52852372e-05,
                    3.52345553e-05,
                    3.74203589e-05,
                    3.69028951e-05,
                    3.82398020e-05,
                    3.61791375e-05,
                    3.81032548e-05,
                    3.75352304e-05,
                    3.72697160e-05,
                    3.79773333e-05,
                    3.64483534e-05,
                    3.61990791e-05,
                    3.75280713e-05,
                    3.75747061e-05,
                    3.51849978e-05,
                    3.69243541e-05,
                    3.45714369e-05,
                    3.57744579e-05,
                    3.27429873e-05,
                    3.40554511e-05,
                    3.21910272e-05,
                    3.29027720e-05,
                    3.09355900e-05,
                    3.19087297e-05,
                    3.02852090e-05,
                    3.00042906e-05,
                    2.78177364e-05,
                    2.85175289e-05,
                    2.82292700e-05,
                    2.85437536e-05,
                    2.84871355e-05,
                    2.62105584e-05,
                    2.91737779e-05,
                    2.75626817e-05,
                    2.77568940e-05,
                    2.61748072e-05,
                    2.70192330e-05,
                    2.60214548e-05,
                    2.62850089e-05,
                    2.86908242e-05,
                    2.56724375e-05,
                    2.79945662e-05,
                    2.68964631e-05,
                    2.89429666e-05,
                    2.76784035e-05,
                    2.80853919e-05,
                    2.75137394e-05,
                    2.97005964e-05,
                    2.94723255e-05,
                    3.00238920e-05,
                    3.05815814e-05,
                    3.11525649e-05,
                    3.05602646e-05,
                    3.29720395e-05,
                    3.20389313e-05,
                    3.18868085e-05,
                    3.21866614e-05,
                    3.29012828e-05,
                    3.26382380e-05,
                    3.06941467e-05,
                    3.13443032e-05,
                    3.18043447e-05,
                    3.11434017e-05,
                    3.06625885e-05,
                    2.93178942e-05,
                    2.92743250e-05,
                    2.67013056e-05,
                    2.68344195e-05,
                    2.38824842e-05,
                    2.33656795e-05,
                    2.08499076e-05,
                    2.00209871e-05,
                    1.79564973e-05,
                    1.81371518e-05,
                    1.51475759e-05,
                    1.43059554e-05,
                    1.35775830e-05,
                    1.08846299e-05,
                    9.54520595e-06,
                    9.27696471e-06,
                    9.01701502e-06,
                    7.71544874e-06,
                    8.84018241e-06,
                    7.31607916e-06,
                    5.91182535e-06,
                    5.56370731e-06,
                    5.09885483e-06,
                    4.30335335e-06,
                    4.15202196e-06,
                    4.13553645e-06,
                    4.52409564e-06,
                    4.02502411e-06,
                    1.97777817e-06,
                    3.17064772e-06,
                    2.82009291e-06,
                    3.49428666e-06,
                    3.52255190e-06,
                    2.53708313e-06,
                    1.92297763e-06,
                    2.85845130e-06,
                    2.44766455e-06,
                    1.91025761e-06,
                    1.44121640e-07,
                    1.40295139e-06,
                    2.30859472e-06,
                    1.81932131e-06,
                    1.40089578e-06,
                    1.50362898e-06,
                    1.61946799e-06,
                    1.14191972e-06,
                    1.57074241e-06,
                    1.14667856e-06,
                    7.31725315e-07,
                ]
            ),
        )
        np.testing.assert_allclose(
            proc_data_dict["ge"][1], 3.823980201945236e-05, rtol=1e-4
        )
        np.testing.assert_allclose(
            proc_data_dict["ge"][2], 6740459461.466683, rtol=1e-4
        )

        qubit_parameters = result.tasks["extract_qubit_parameters"].output
        np.testing.assert_almost_equal(
            qubit_parameters["old_parameter_values"]["q0"][
                "readout_resonator_frequency"
            ],
            7.1e9,
        )
        np.testing.assert_allclose(
            qubit_parameters["new_parameter_values"]["q0"][
                "readout_resonator_frequency"
            ],
            6740459461.466683,
            rtol=1e-4,
        )

    def test_create_and_run_gef(
        self, single_tunable_transmon_platform, results_single_qubit
    ):
        [q0] = single_tunable_transmon_platform.qpu.qubits
        options = dispersive_shift.analysis_workflow.options()

        result = dispersive_shift.analysis_workflow(
            result=results_single_qubit[0],
            qubit=q0,
            frequencies=results_single_qubit[1],
            states="gef",
            options=options,
        ).run()

        proc_data_dict = result.tasks["calculate_signal_differences"].output
        assert len(proc_data_dict) == 4
        np.testing.assert_array_almost_equal(
            proc_data_dict["sum"][0],
            np.array(
                [
                    2.99919389e-06,
                    3.64811496e-06,
                    3.36017552e-06,
                    3.88077743e-06,
                    3.26024827e-06,
                    2.72129040e-06,
                    2.73905095e-06,
                    2.12819805e-06,
                    4.16134587e-06,
                    3.97209696e-06,
                    5.92552504e-06,
                    4.29989583e-06,
                    6.57297654e-06,
                    5.60912676e-06,
                    4.10905667e-06,
                    5.93191819e-06,
                    4.49210270e-06,
                    5.02461904e-06,
                    5.80689480e-06,
                    7.74603622e-06,
                    8.20653848e-06,
                    8.31236308e-06,
                    8.18060319e-06,
                    8.52484214e-06,
                    1.11318777e-05,
                    1.14266552e-05,
                    1.00740220e-05,
                    1.33002951e-05,
                    1.40402529e-05,
                    1.51095009e-05,
                    1.38422659e-05,
                    1.79768748e-05,
                    2.14167280e-05,
                    1.55676654e-05,
                    2.27796656e-05,
                    2.35331775e-05,
                    2.64886693e-05,
                    3.31524866e-05,
                    3.20619658e-05,
                    3.43208779e-05,
                    4.01289756e-05,
                    4.07817302e-05,
                    4.38570083e-05,
                    4.72101036e-05,
                    4.93875922e-05,
                    5.38744227e-05,
                    5.24261575e-05,
                    5.22401251e-05,
                    5.51196147e-05,
                    5.41373161e-05,
                    5.21131784e-05,
                    5.05311908e-05,
                    5.07250218e-05,
                    5.26212495e-05,
                    5.14406763e-05,
                    4.96708920e-05,
                    5.21570706e-05,
                    5.02609043e-05,
                    5.58167505e-05,
                    5.59339487e-05,
                    5.59617981e-05,
                    5.83028832e-05,
                    6.05215046e-05,
                    6.30635962e-05,
                    6.47616508e-05,
                    6.52067555e-05,
                    7.06671910e-05,
                    6.85770721e-05,
                    7.53661478e-05,
                    7.34105795e-05,
                    7.58332927e-05,
                    7.58890055e-05,
                    7.87188307e-05,
                    7.57606957e-05,
                    7.85464241e-05,
                    8.21785438e-05,
                    8.02829081e-05,
                    7.93327261e-05,
                    8.03717933e-05,
                    7.83280256e-05,
                    8.46091339e-05,
                    8.30101555e-05,
                    8.26335307e-05,
                    8.28753364e-05,
                    8.43524888e-05,
                    8.54091788e-05,
                    8.70833746e-05,
                    8.71372550e-05,
                    8.68002465e-05,
                    8.90130401e-05,
                    9.03742127e-05,
                    9.38349321e-05,
                    9.53753322e-05,
                    8.89703829e-05,
                    9.57417600e-05,
                    9.65935484e-05,
                    9.80067401e-05,
                    9.72476311e-05,
                    9.74371872e-05,
                    9.83931876e-05,
                    9.87663118e-05,
                    9.85409071e-05,
                    9.47850067e-05,
                    9.86403793e-05,
                    9.54361771e-05,
                    9.39652792e-05,
                    9.29855174e-05,
                    8.98904092e-05,
                    8.80412857e-05,
                    9.03785806e-05,
                    8.66854088e-05,
                    8.73794787e-05,
                    8.55100512e-05,
                    8.53677692e-05,
                    7.98045598e-05,
                    8.31012262e-05,
                    8.14220886e-05,
                    8.25904755e-05,
                    7.77247610e-05,
                    7.94664459e-05,
                    7.86251969e-05,
                    8.04039162e-05,
                    7.72321492e-05,
                    7.73721666e-05,
                    7.76967513e-05,
                    7.79443486e-05,
                    7.58196503e-05,
                    8.24142904e-05,
                    7.73847035e-05,
                    7.81804893e-05,
                    7.97646542e-05,
                    8.27575840e-05,
                    8.17640298e-05,
                    8.23632327e-05,
                    8.26313396e-05,
                    8.40042408e-05,
                    8.65222975e-05,
                    8.64772969e-05,
                    9.06759596e-05,
                    8.74500523e-05,
                    9.00707849e-05,
                    8.98477476e-05,
                    9.06467027e-05,
                    9.10873444e-05,
                    8.96286160e-05,
                    9.19263351e-05,
                    8.99064271e-05,
                    8.99294916e-05,
                    8.80975614e-05,
                    8.76878639e-05,
                    8.90354197e-05,
                    8.38730339e-05,
                    8.20923359e-05,
                    7.74791507e-05,
                    7.45583656e-05,
                    7.13266389e-05,
                    6.61884541e-05,
                    6.19931478e-05,
                    5.80082649e-05,
                    5.52659026e-05,
                    4.88970909e-05,
                    4.79784448e-05,
                    4.28390411e-05,
                    3.95778026e-05,
                    3.73975950e-05,
                    3.18130268e-05,
                    2.66049219e-05,
                    2.61252791e-05,
                    2.69858561e-05,
                    2.36461702e-05,
                    2.25010774e-05,
                    2.09582385e-05,
                    1.51558454e-05,
                    1.30384309e-05,
                    1.30132924e-05,
                    1.24309712e-05,
                    1.28543738e-05,
                    1.19404363e-05,
                    1.20617140e-05,
                    1.11083685e-05,
                    6.72822451e-06,
                    8.60782181e-06,
                    8.32756452e-06,
                    9.79818341e-06,
                    7.05552854e-06,
                    7.37109384e-06,
                    4.16213696e-06,
                    7.13121005e-06,
                    4.89577013e-06,
                    3.84094307e-06,
                    1.34253450e-06,
                    4.35318743e-06,
                    4.82734673e-06,
                    6.71099187e-06,
                    5.12183529e-06,
                    3.33543184e-06,
                    5.17714221e-06,
                    3.84462149e-06,
                    4.28324751e-06,
                    3.87057454e-06,
                    2.73107072e-06,
                ]
            ),
        )

        np.testing.assert_allclose(
            proc_data_dict["sum"][1], 9.876631183903248e-05, rtol=1e-4
        )
        np.testing.assert_allclose(
            proc_data_dict["sum"][2], 6744459461.466683, rtol=1e-4
        )

        qubit_parameters = result.tasks["extract_qubit_parameters"].output
        np.testing.assert_almost_equal(
            qubit_parameters["old_parameter_values"]["q0"][
                "readout_resonator_frequency"
            ],
            7.1e9,
        )
        np.testing.assert_allclose(
            qubit_parameters["new_parameter_values"]["q0"][
                "readout_resonator_frequency"
            ],
            6744459461.466683,
        )

    def test_create_and_run_no_plotting(
        self, single_tunable_transmon_platform, results_single_qubit
    ):
        [q0] = single_tunable_transmon_platform.qpu.qubits
        options = dispersive_shift.analysis_workflow.options()

        # Disable signal distances plotting
        options.do_plotting_signal_distances(False)
        result = dispersive_shift.analysis_workflow(
            result=results_single_qubit[0],
            qubit=q0,
            frequencies=results_single_qubit[1],
            states="ge",
            options=options,
        ).run()
        assert len(result.tasks) == 3
        task_names = [t.name for t in result.tasks]
        assert "calculate_signal_differences" in task_names
        assert "extract_qubit_parameters" in task_names
        assert "plot_dispersive_shift" in task_names
        assert "plot_signal_distances" not in task_names

        # Disable dispersive shift plotting
        options.do_plotting_dispersive_shift(False)
        options.do_plotting_signal_distances(True)
        result = dispersive_shift.analysis_workflow(
            result=results_single_qubit[0],
            qubit=q0,
            frequencies=results_single_qubit[1],
            states="ge",
            options=options,
        ).run()
        assert len(result.tasks) == 3
        task_names = [t.name for t in result.tasks]
        assert "calculate_signal_differences" in task_names
        assert "extract_qubit_parameters" in task_names
        assert "plot_dispersive_shift" not in task_names
        assert "plot_signal_distances" in task_names

        # Disable plotting entirely
        options.do_plotting(False)
        result = dispersive_shift.analysis_workflow(
            result=results_single_qubit[0],
            qubit=q0,
            frequencies=results_single_qubit[1],
            states="ge",
            options=options,
        ).run()
        assert len(result.tasks) == 2
        task_names = [t.name for t in result.tasks]
        assert "calculate_signal_differences" in task_names
        assert "extract_qubit_parameters" in task_names
        assert "plot_dispersive_shift" not in task_names
        assert "plot_signal_distances" not in task_names

    def test_create_and_run_close_figures(
        self, single_tunable_transmon_platform, results_single_qubit
    ):
        [q0] = single_tunable_transmon_platform.qpu.qubits
        options = dispersive_shift.analysis_workflow.options()
        options.close_figures(True)

        result = dispersive_shift.analysis_workflow(
            result=results_single_qubit[0],
            qubit=q0,
            frequencies=results_single_qubit[1],
            states="ge",
            options=options,
        ).run()

        assert isinstance(
            result.tasks["plot_dispersive_shift"].output, mpl.figure.Figure
        )
        assert isinstance(
            result.tasks["plot_signal_distances"].output, mpl.figure.Figure
        )

        options.close_figures(False)
        result = dispersive_shift.analysis_workflow(
            result=results_single_qubit[0],
            qubit=q0,
            frequencies=results_single_qubit[1],
            states="ge",
            options=options,
        ).run()

        assert isinstance(
            result.tasks["plot_dispersive_shift"].output, mpl.figure.Figure
        )
        assert isinstance(
            result.tasks["plot_signal_distances"].output, mpl.figure.Figure
        )
        plt.close(result.tasks["plot_dispersive_shift"].output)
        plt.close(result.tasks["plot_signal_distances"].output)
