.template_test:
  stage: test
  tags:
    - linux
    - docker
  variables:
    USE_LABONEQ_DEVELOP: "false"
    MPLBACKEND: "AGG"
    UV_NO_SYNC: "1" # don't implicitly sync during "uv run"
  before_script:
    - |
      if [[ $USE_LABONEQ_DEVELOP == "true" ]]; then
        # WARNING: Below will pick the latest pre-release ONLY if the supplied index
        # contains exclusively pre-release versions. Currently, LabOne Q is using internal artifactory index
        # for alpha releases, so this is true.
        uv sync --prerelease=if-necessary-or-explicit --upgrade-package laboneq \
                --index=https://artifactory.zhinst.com/artifactory/api/pypi/ZIPyPI/simple
      else
        uv lock --upgrade-package laboneq
        uv sync
      fi
  script:
    - uv run pytest tests -n=auto -vv --ignore=tests/contrib
  rules:
    - !reference [.non_triggered]

test:python-3.10:
  extends: ".template_test"
  variables:
    UV_PYTHON: "3.10"

test:python-3.11:
  extends: ".template_test"
  variables:
    UV_PYTHON: "3.11"

test:python-3.12:
  extends: ".template_test"
  variables:
    UV_PYTHON: "3.12"

test:python-3.13:
  extends: ".template_test"
  variables:
    UV_PYTHON: "3.13"

test:python-3.10:laboneq-release:
  extends: ".template_test"
  variables:
    UV_PYTHON: "3.10"
    USE_LABONEQ_DEVELOP: "false"
  allow_failure: true

test:coverage:
  extends: ".template_test"
  variables:
    UV_PYTHON: "3.10"
  script:
    - uv run pytest tests -v --ignore=tests/contrib --cov=laboneq_applications --cov=tests --cov-branch --cov-config=ci/coveragerc -n=auto
    - uv run coverage xml -o coverage.xml
    - uv run coverage html -d coverage_html
  artifacts:
    paths:
      - coverage_html
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 day
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'

test:docs_notebooks:python-3.10:
  extends: ".template_test"
  variables:
    UV_PYTHON: "3.10"
  script:
    - uv run pytest --nbmake docs/sources --nbmake-kernel=python --nbmake-timeout=240 -n=auto --durations=0

test:contrib_smoke_test:
  extends: ".template_test"
  script:
    - uv run pytest tests/contrib -n=auto -vv

test:laboneq-feature-branch:
  when: manual
  variables:
    VERSION: "OVERRIDE WITH LABONEQ VERSION"
    UV_NO_SYNC: "1" # don't implicitly sync during "uv run"
  stage: test
  script:
    - |
      uv sync --prerelease=if-necessary-or-explicit \
              --upgrade-package laboneq==${VERSION} \
              --index=$LABONEQ_INDEX_URL
    - uv run pytest tests -n=auto -vv

.template_triggered_test:
  stage: test
  variables:
    LABONEQ_INDEX_URL: https://gitlab.zhinst.com/api/v4/projects/251/packages/pypi
    UV_NO_SYNC: "1" # don't implicitly sync during "uv run"
  before_script:
    - echo "Triggered by $UPSTREAM_PROJECT_PATH/$UPSTREAM_PROJECT_PATH"
    - echo "Running tests with laboneq version $LABONEQ_VERSION"
    - |
      uv sync --prerelease=if-necessary-or-explicit \
              --upgrade-package laboneq==${LABONEQ_VERSION} \
              --index=$LABONEQ_INDEX_URL
  rules:
    - !reference [.triggered]

test:triggered-by-laboneq:
  extends: ".template_triggered_test"
  script:
    - uv run pytest tests -n=auto -vv --ignore=tests/contrib

test:docs-notebooks-triggered-by-laboneq:
  extends: ".template_triggered_test"
  script:
    - uv run pytest --nbmake docs/sources --nbmake-kernel=python --nbmake-timeout=240 -n=auto --durations=0
