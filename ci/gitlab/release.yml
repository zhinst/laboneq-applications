deploy:build-distribution:
  stage: deploy
  script:
    - uv build -o ./dist
  only:
    variables:
      - $CI_COMMIT_TAG =~ /^v\d+.\d+.\d+-?.*$/
  artifacts:
    paths:
      - dist
    expire_in: 21 days

deploy:deploy-internal:
  stage: deploy
  needs: ["deploy:build-distribution"]
  script:
    - |
      uv publish \
        --publish-url "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi" \
        --check-url "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi/simple" \
        --username "gitlab-ci-token" \
        --password "$CI_JOB_TOKEN"
  only:
    variables:
      - $CI_COMMIT_TAG =~ /^v\d+.\d+.\d+-?.*$/

deploy:deploy-pypi:
  stage: deploy
  needs: ["deploy:build-distribution"]
  script:
    - uv publish ./dist/* --token $PYPI_TOKEN
  only:
    variables:
      - $CI_COMMIT_TAG =~ /^v\d+.\d+.\d+-?.*$/
